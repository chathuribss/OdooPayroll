<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <template id="bank_sheet_report_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <t t-if="docs.slip_ids[0].struct_id.name == 'PBSS Salary Structure'">
                        <center>
                            <h3>
                                <td colspan="8" style="text-align: center;">Salary Sheet<br></br></td>
                            </h3>
                        </center><br/>
                    </t>
                    <t t-if="docs.slip_ids[0].struct_id.name == 'PBSS Allowance Structure'">
                        <center>
                            <h3>
                                <td colspan="8" style="text-align: center;">Allowance Sheet<br></br></td>
                            </h3>
                        </center><br/>
                    </t>
                    <h4><span t-field="docs.name"/></h4>

                    <!-- Loop through the chunks (each containing 15 records max) -->
                    <t t-foreach="docs.get_slip_chunks()[0]" t-as="chunk">
                        <!-- Start a new table for each chunk -->
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th name="emp_id"><strong>EMP No</strong></th>
                                    <th name="emp_name"><strong>Name</strong></th>
                                    <th name="emp_nic"><strong>NIC</strong></th>
                                    <th name="emp_bank_number"><strong>Peoples Bank Ac No</strong></th>
                                    <th name="emp_net" style="text-align:right;"><strong>Amount</strong></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Loop through each slip record in the chunk -->
                                <t t-foreach="chunk['slips']" t-as="doc">
                                    <tr>
                                        <td style="text-align:center;"><span t-field="doc.employee_id.barcode"/></td>
                                        <td style="text-align:center;"><span t-field="doc.employee_id.display_name"/></td>
                                        <td style="text-align:center;"><span t-field="doc.employee_id.x_studio_nic"/></td>

                                        <t t-if="docs.slip_ids[0].struct_id.name == 'PBSS Allowance Structure'">
                                        </t>

                                        <t t-if="doc.employee_id.x_studio_allowance_savings_account_number">
                                            <td style="text-align:center;"><span t-field="doc.employee_id.x_studio_allowance_savings_account_number"/></td>
                                        </t>
                                        <t t-else="">
                                            <td style="text-align:center;"><span t-field="doc.employee_id.x_studio_savings_account_number"/></td>
                                        </t>

                                        <td style="text-align:right;">
                                            <t t-foreach="doc.line_ids.filtered(lambda line: line.appears_on_payslip and line.category_id.name == 'Net Salary')" t-as="net">
                                                <span t-esc="net.total" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}' t-att-style="'color:#875A7B;' if net.total &lt; 0 else ''"/>
                                            </t>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                            <!-- Page total -->
                            <tfoot>
                                <tr>
                                    <td colspan="4" style="text-align:right;"><strong>Page Total</strong></td>
                                    <td style="text-align:right;"><strong><span t-esc="chunk['page_total']" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></strong></td>
                                </tr>
                            </tfoot>
                        </table>

                        <!-- Add page break after each table (except the last one) -->
                        <t t-if="chunk != docs.get_slip_chunks()[0][-1]">
                            <div style="page-break-after: always;"></div>
                        </t>
                    </t>
                    <!-- Final grand total on the last page -->
                    <table class="table table-bordered">
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align:right;"><strong>Grand Total</strong></td>
                                <td style="text-align:right;"><strong><span t-esc="docs.get_grand_total()" t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/></strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </t>
        </t>
    </template>

    <record id="bank_sheet_report_action" model="ir.actions.report">
        <field name="name">Bank Sheet</field>
        <field name="model">hr.payslip.run</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">send_payslips_by_email.bank_sheet_report_template</field>
        <field name="report_file">send_payslips_by_email.bank_sheet_report_template</field>
        <field name="print_report_name">"Bank Sheet"</field>
    </record>
</odoo>
